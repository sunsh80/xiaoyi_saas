/**
 * 租户注册与工人入驻业务流程说明
 * 
 * 更新日期：2026-02-17
 */

# 小蚁搬运注册业务流程

## 一、业务流程图

```
                    ┌─────────────────┐
                    │  小程序登录页    │
                    │  底部"立即注册"  │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  注册类型选择页  │
                    │  ┌─────┐ ┌─────┐│
                    │  │租户 │ │工人 ││
                    │  └──┬──┘ └──┬──┘│
                    └─────┼───────┼────┘
                          │       │
              ┌───────────┘       └───────────┐
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │   租户注册      │             │   工人入驻      │
    │ (需总后台审批)  │             │ (无需审批)      │
    │                 │             │                 │
    │ 填写企业信息    │             │ 填写个人信息    │
    │ 联系人信息      │             │ 选择技能标签    │
    │ 管理员账户      │             │ 设置账户密码    │
    │                 │             │                 │
    │ 提交 → 待审批   │             │ 提交 → 直接入驻 │
    │ status=0        │             │ status=1        │
    │ ↓               │             │                 │
    │ 总后台审批      │             │ 归属公共工人池  │
    │ ↓               │             │ tenant_id=NULL  │
    │ 审批通过        │             │                 │
    │ ↓               │             │ 可立即接单      │
    │ 生成租户编码    │             │                 │
    │ TN202602171234  │             │                 │
    │ status=1        │             │                 │
    │ 可登录使用      │             │                 │
    └─────────────────┘             └─────────────────┘
```

## 二、前端页面结构

### 2.1 页面路径

```
frontend/miniprogram/pages/
├── login/                      # 登录页
│   ├── login.js
│   ├── login.wxml
│   └── login.wxss
└── auth/
    ├── register-type/          # 注册类型选择页
    │   ├── register-type.js
    │   ├── register-type.wxml
    │   └── register-type.wxss
    ├── tenant-register/        # 租户注册页
    │   ├── tenant-register.js
    │   ├── tenant-register.wxml
    │   └── tenant-register.wxss
    └── worker-register/        # 工人注册页
        ├── worker-register.js
        ├── worker-register.wxml
        └── worker-register.wxss
```

### 2.2 跳转逻辑

1. **登录页** → 点击"立即注册" → **注册类型选择页**
2. **注册类型选择页** → 点击"我是租户" → **租户注册页**
3. **注册类型选择页** → 点击"我是工人" → **工人注册页**

## 三、后端 API

### 3.1 租户注册 API

**接口**: `POST /api/auth/tenant-register`

**请求参数**:
```json
{
  "tenant_name": "企业名称",
  "contact_person": "联系人姓名",
  "contact_phone": "联系电话",
  "contact_email": "联系邮箱（可选）",
  "address": "企业地址（可选）",
  "admin_username": "管理员用户名",
  "admin_password": "管理员密码",
  "admin_real_name": "管理员真实姓名（可选）"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "注册申请已提交，请等待总后台审批",
  "data": {
    "tenant": {
      "id": 1,
      "code": "TN202602171234",
      "name": "企业名称",
      "status": "pending"
    },
    "user": {
      "id": 1,
      "username": "管理员用户名"
    }
  }
}
```

**业务逻辑**:
1. 验证必填字段
2. 检查联系电话是否已注册
3. 生成唯一租户编码（格式：TN + YYYYMMDD + 4 位随机数）
4. 创建租户记录，status=0（待审批）
5. 创建租户管理员账户，status=0（待激活）
6. 不返回 token，需等待审批后才能登录

### 3.2 工人注册 API

**接口**: `POST /api/auth/worker-register`

**请求参数**:
```json
{
  "real_name": "真实姓名",
  "phone": "手机号",
  "id_card": "身份证号（可选）",
  "username": "用户名",
  "password": "密码",
  "skills": "技能标签，逗号分隔"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "入驻成功",
  "data": {
    "user": {
      "id": 1,
      "username": "用户名",
      "real_name": "真实姓名",
      "role": "worker"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**业务逻辑**:
1. 验证必填字段
2. 检查手机号/用户名是否已注册
3. 创建工人账户，tenant_id=NULL（公共工人池）
4. status=1（直接激活）
5. 返回 JWT token，可立即登录使用

## 四、数据库设计

### 4.1 租户表 (tenants)

```sql
CREATE TABLE tenants (
  id INT PRIMARY KEY AUTO_INCREMENT,
  tenant_code VARCHAR(50) UNIQUE NOT NULL COMMENT '租户编码',
  name VARCHAR(100) NOT NULL COMMENT '租户名称',
  contact_person VARCHAR(50) NOT NULL COMMENT '联系人',
  contact_phone VARCHAR(20) NOT NULL COMMENT '联系电话',
  contact_email VARCHAR(100) COMMENT '联系邮箱',
  address VARCHAR(255) COMMENT '地址',
  status TINYINT DEFAULT 0 COMMENT '状态：0-待审批，1-已激活，2-已禁用',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 4.2 用户表 (users)

```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  tenant_id INT COMMENT '租户 ID（NULL 表示公共工人）',
  username VARCHAR(50) NOT NULL COMMENT '用户名',
  password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
  phone VARCHAR(20) NOT NULL COMMENT '手机号',
  real_name VARCHAR(50) COMMENT '真实姓名',
  id_card VARCHAR(20) COMMENT '身份证号',
  skills VARCHAR(255) COMMENT '技能标签',
  role ENUM('tenant_admin', 'tenant_user', 'worker') NOT NULL COMMENT '角色',
  status TINYINT DEFAULT 0 COMMENT '状态：0-待激活，1-已激活，2-已禁用',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);
```

## 五、总后台审批功能

### 5.1 待审批租户列表

**接口**: `GET /api/admin/tenants/pending`

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "tenant_code": "TN202602171234",
      "name": "企业名称",
      "contact_person": "联系人",
      "contact_phone": "13800138000",
      "created_at": "2024-02-17 10:30:00"
    }
  ]
}
```

### 5.2 审批通过

**接口**: `PUT /api/admin/tenants/:id/approve`

**业务逻辑**:
1. 更新租户 status=1
2. 更新租户管理员用户 status=1
3. 可选：发送短信/邮件通知

### 5.3 审批拒绝

**接口**: `DELETE /api/admin/tenants/:id/reject`

**业务逻辑**:
1. 删除租户记录
2. 删除租户管理员用户记录
3. 可选：发送通知

## 六、登录流程

### 6.1 租户管理员登录

**接口**: `POST /api/auth/tenant-login`

**请求头**: `x-tenant-code: TN202602171234`

**请求体**:
```json
{
  "username": "管理员用户名",
  "password": "密码"
}
```

**响应**:
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "user": { ... },
    "token": "..."
  }
}
```

**注意**: 如果租户待审批（status=0），登录会失败，提示"账户待审批"

### 6.2 公共工人登录

**接口**: `POST /api/auth/worker-login`

**请求体**:
```json
{
  "username": "用户名/手机号",
  "password": "密码"
}
```

**响应**: 同租户管理员登录

## 七、租户编码生成规则

### 7.1 格式

```
TN + YYYYMMDD + 4 位随机数
```

**示例**:
- `TN202602171234` - 2026 年 2 月 17 日生成的第 1234 号租户
- `TN202602180001` - 2026 年 2 月 18 日生成的第 0001 号租户

### 7.2 生成逻辑

```javascript
static generateTenantCode() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  
  return `TN${year}${month}${day}${randomNum}`;
}
```

### 7.3 唯一性保证

1. 生成后查询数据库是否已存在
2. 如存在则重新生成（最多尝试 10 次）
3. 数据库层面有 UNIQUE 约束

## 八、角色权限说明

| 角色 | 说明 | 租户编码 | 审批要求 |
|-----|------|---------|---------|
| tenant_admin | 租户管理员 | 有 | 需要 |
| tenant_user | 租户普通用户 | 有 | 无需（租户管理员创建） |
| worker | 公共工人 | 无 | 无需 |

## 九、状态说明

### 租户状态 (tenants.status)
- `0` - 待审批（刚注册）
- `1` - 已激活（审批通过）
- `2` - 已禁用（审批拒绝或违规）

### 用户状态 (users.status)
- `0` - 待激活（租户待审批）
- `1` - 已激活（可正常使用）
- `2` - 已禁用（违规或离职）

## 十、后续优化建议

1. **短信通知**: 审批结果通过短信通知租户
2. **邮件通知**: 发送审批结果邮件
3. **审批备注**: 总后台审批时可填写备注
4. **自动审批**: 对于可信渠道的注册可设置自动审批
5. **租户编码自定义**: 允许总后台在审批时自定义租户编码
6. **工人实名认证**: 接入第三方实名认证 API
7. **工人技能认证**: 上传技能证书，总后台审核
