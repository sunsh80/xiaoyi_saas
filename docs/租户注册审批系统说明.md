# 租户注册与审批系统使用说明

## 更新日期：2026-02-17

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     小蚁搬运平台                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   小程序端   │    │  总后台管理  │    │  租户管理后台│     │
│  │             │    │             │    │             │     │
│  │ - 用户登录   │    │ - 租户审批   │    │ - 订单管理   │     │
│  │ - 租户注册   │    │ - 租户管理   │    │ - 工人管理   │     │
│  │ - 工人入驻   │    │ - 财务管理   │    │ - 用户管理   │     │
│  │ - 订单下单   │    │ - 报表统计   │    │ - 财务报表   │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                     后端 API 服务                             │
│  - 认证服务（登录、注册、JWT）                                │
│  - 租户服务（注册、审批、管理）                               │
│  - 订单服务（创建、分配、完成）                               │
│  - 工人服务（入驻、接单、位置）                               │
│  - 财务服务（支付、结算、提现）                               │
├─────────────────────────────────────────────────────────────┤
│                     MySQL 数据库                             │
│  - tenants 表（租户信息）                                    │
│  - users 表（用户信息）                                      │
│  - orders 表（订单信息）                                     │
│  - workers 表（工人信息）                                    │
│  - 财务相关表                                                │
└─────────────────────────────────────────────────────────────┘
```

## 二、租户注册流程

### 2.1 小程序端注册

**页面路径**: `/pages/auth/register-type/register-type`

**流程**:
1. 用户打开小程序 → 登录页
2. 点击"立即注册"
3. 选择"我是租户"
4. 填写注册表单：
   - 企业名称 *
   - 企业地址
   - 联系人姓名 *
   - 联系电话 *
   - 联系邮箱
   - 管理员用户名 *
   - 管理员密码 *
   - 管理员确认密码 *
5. 提交注册

**后端处理**:
```javascript
POST /api/auth/tenant-register
{
  "tenant_name": "企业名称",
  "contact_person": "联系人",
  "contact_phone": "13800138000",
  "contact_email": "email@example.com",
  "address": "企业地址",
  "admin_username": "admin",
  "admin_password": "password123",
  "admin_real_name": "管理员姓名"
}
```

**响应**:
```json
{
  "success": true,
  "message": "注册申请已提交，请等待总后台审批",
  "data": {
    "tenant": {
      "id": 1,
      "code": "TN202602171234",
      "name": "企业名称",
      "status": "pending"
    },
    "user": {
      "id": 1,
      "username": "admin"
    }
  }
}
```

**数据库状态**:
- `tenants.status = 0` (待审批)
- `users.status = 0` (待激活)

### 2.2 总后台审批

**访问地址**: http://localhost:4000/admin/login.html

**审批流程**:
1. 登录总后台
2. 点击左侧导航"租户管理"
3. 点击"待审批"按钮（显示待审批数量）
4. 查看待审批租户列表
5. 点击"审批"按钮
6. 弹出审批模态框：
   - 显示租户名称
   - 显示系统生成的租户编码
   - 可输入自定义租户编码（可选）
7. 选择"通过"或"拒绝"

**审批通过 API**:
```javascript
PUT /api/admin/tenants/:id/approve
{
  "tenant_code": "CUSTOM_CODE" // 可选，留空使用系统生成的编码
}
```

**审批拒绝 API**:
```javascript
PUT /api/admin/tenants/:id/reject
{
  "reason": "拒绝原因（选填）"
}
```

**审批后状态**:
- **通过**: `tenants.status = 1`, `users.status = 1`
- **拒绝**: `tenants.status = 2`, 删除管理员用户

### 2.3 租户登录

**访问地址**: http://localhost:4000/tenant-admin/login.html

**登录信息**:
- **租户编码**: 系统生成或自定义（如 TN202602171234）
- **用户名**: 注册时设置的管理员用户名
- **密码**: 注册时设置的管理员密码

**登录 API**:
```javascript
POST /api/auth/tenant-login
Headers:
  x-tenant-code: TN202602171234
Body:
{
  "username": "admin",
  "password": "password123"
}
```

## 三、工人入驻流程

### 3.1 小程序端入驻

**页面路径**: `/pages/auth/worker-register/worker-register`

**流程**:
1. 用户打开小程序 → 登录页
2. 点击"立即注册"
3. 选择"我是工人"
4. 填写入驻表单：
   - 真实姓名 *
   - 手机号 *
   - 身份证号（可选，用于实名认证）
   - 用户名 *
   - 密码 *
   - 确认密码 *
   - 技能标签（多选）：搬运、装卸、配送、打包、整理、其他
   - 同意入驻协议 *
5. 提交入驻

**后端处理**:
```javascript
POST /api/auth/worker-register
{
  "real_name": "张三",
  "phone": "13800138000",
  "id_card": "身份证号（可选）",
  "username": "zhangsan",
  "password": "password123",
  "skills": "搬运，装卸"
}
```

**响应**:
```json
{
  "success": true,
  "message": "入驻成功",
  "data": {
    "user": {
      "id": 1,
      "username": "zhangsan",
      "real_name": "张三",
      "role": "worker"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**数据库状态**:
- `users.tenant_id = NULL` (公共工人池)
- `users.role = 'worker'`
- `users.status = 1` (已激活)

### 3.2 工人登录

**登录方式**: 小程序登录页

**登录信息**:
- 用户名/手机号
- 密码

**特点**:
- 归属公共工人池
- 无租户编码
- 可跨租户接单
- 无需审批，直接激活

## 四、租户编码管理

### 4.1 自动生成规则

**格式**: `TN + YYYYMMDD + 4 位随机数`

**示例**:
- `TN202602171234` - 2026 年 2 月 17 日生成
- `TN202602180001` - 2026 年 2 月 18 日生成

**生成逻辑**:
```javascript
static generateTenantCode() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  
  return `TN${year}${month}${day}${randomNum}`;
}
```

**唯一性保证**:
1. 生成后查询数据库是否已存在
2. 如存在则重新生成（最多尝试 10 次）
3. 数据库层面有 UNIQUE 约束

### 4.2 自定义编码

**使用场景**: 总后台审批租户时

**操作**:
1. 点击"审批"按钮
2. 在"自定义租户编码"输入框填写
3. 留空则使用系统自动生成的编码

**建议规则**:
- 公司简称：`XIAOMI`、`TENCENT`
- 品牌名：`SF_EXPRESS`、`JD_LOGISTICS`
- 拼音缩写：`ZTZY`（中通快运）

**注意事项**:
- 确保编码唯一性
- 避免使用特殊字符
- 建议使用大写字母和数字

## 五、状态管理

### 5.1 租户状态 (tenants.status)

| 状态码 | 状态名称 | 说明 | 操作 |
|-------|---------|------|------|
| 0 | 待审批 | 刚注册，等待总后台审批 | 审批通过/拒绝 |
| 1 | 启用 | 审批通过，可正常使用 | 禁用 |
| 2 | 已禁用 | 审批拒绝或违规禁用 | 启用 |

### 5.2 用户状态 (users.status)

| 状态码 | 状态名称 | 说明 | 操作 |
|-------|---------|------|------|
| 0 | 待激活 | 租户待审批，用户不可用 | 自动激活（审批通过时） |
| 1 | 已激活 | 可正常登录使用 | 禁用 |
| 2 | 已禁用 | 账户被禁用 | 启用 |

### 5.3 状态联动

**租户审批通过**:
```
tenants.status: 0 → 1
users.status: 0 → 1 (租户管理员)
```

**租户被禁用**:
```
tenants.status: 1 → 2
users.status: 1 → 2 (租户下所有用户)
```

**租户被删除**:
```
1. 检查是否有订单（有订单则不允许删除）
2. 删除租户下所有用户
3. 删除租户（或软删除：status=2）
```

## 六、API 接口列表

### 6.1 认证相关

| 接口 | 方法 | 权限 | 说明 |
|------|------|------|------|
| `/api/auth/tenant-register` | POST | 公开 | 租户注册 |
| `/api/auth/worker-register` | POST | 公开 | 工人入驻 |
| `/api/auth/tenant-login` | POST | 公开 | 租户管理员登录 |
| `/api/auth/worker-login` | POST | 公开 | 公共工人登录 |
| `/api/auth/login` | POST | 公开 | 租户用户登录 |
| `/api/auth/register` | POST | 认证用户 | 租户下用户注册 |

### 6.2 租户管理（总后台）

| 接口 | 方法 | 权限 | 说明 |
|------|------|------|------|
| `/api/admin/tenants` | GET | 总后台 | 获取租户列表 |
| `/api/admin/tenants/pending` | GET | 总后台 | 获取待审批租户 |
| `/api/admin/tenants/:id` | GET | 总后台 | 获取租户详情 |
| `/api/admin/tenants/:id/approve` | PUT | 总后台 | 审批通过 |
| `/api/admin/tenants/:id/reject` | PUT | 总后台 | 审批拒绝 |
| `/api/admin/tenants/:id` | PUT | 总后台 | 更新租户 |
| `/api/admin/tenants/:id` | DELETE | 总后台 | 删除租户 |
| `/api/admin/tenants/:id/toggle-status` | PUT | 总后台 | 启用/禁用 |

### 6.3 租户管理（租户后台）

| 接口 | 方法 | 权限 | 说明 |
|------|------|------|------|
| `/api/tenant/info` | GET | 租户管理员 | 获取租户信息 |
| `/api/tenant/dashboard` | GET | 租户管理员 | 获取仪表盘数据 |
| `/api/tenant/orders` | GET | 租户管理员 | 获取订单列表 |
| `/api/tenant/workers` | GET | 租户管理员 | 获取工人列表 |
| `/api/tenant/users` | GET | 租户管理员 | 获取用户列表 |
| `/api/tenant/finance/overview` | GET | 租户管理员 | 获取财务总览 |
| `/api/tenant/settings` | PUT | 租户管理员 | 更新租户设置 |

## 七、常见问题

### 7.1 租户注册失败

**问题**: 提示"该联系电话已被注册"

**原因**: 同一个联系电话只能注册一个租户

**解决**: 更换联系电话或使用其他手机号

### 7.2 租户编码重复

**问题**: 自定义租户编码时提示"租户编码已存在"

**原因**: 租户编码必须唯一

**解决**: 更换其他编码或留空使用系统自动生成

### 7.3 租户无法登录

**问题**: 租户管理员登录时提示"账户待审批"

**原因**: 租户状态为 0（待审批），用户状态也为 0（待激活）

**解决**: 联系总后台管理员进行审批

### 7.4 工人无法接单

**问题**: 工人登录后无法查看订单

**原因**: 
1. 工人信息未完善
2. 该区域无订单

**解决**: 
1. 完善个人信息和技能标签
2. 等待新订单发布

### 7.5 删除租户失败

**问题**: 删除租户时提示"该租户下有订单，无法删除"

**原因**: 租户下有订单记录，为防止数据丢失不允许删除

**解决**: 
1. 先处理完所有订单
2. 或使用"禁用"功能代替删除

## 八、数据字典

### 8.1 tenants 表

```sql
CREATE TABLE tenants (
  id INT PRIMARY KEY AUTO_INCREMENT,
  tenant_code VARCHAR(50) UNIQUE NOT NULL COMMENT '租户编码',
  name VARCHAR(100) NOT NULL COMMENT '租户名称',
  contact_person VARCHAR(50) NOT NULL COMMENT '联系人',
  contact_phone VARCHAR(20) NOT NULL COMMENT '联系电话',
  contact_email VARCHAR(100) COMMENT '联系邮箱',
  address VARCHAR(255) COMMENT '地址',
  status TINYINT DEFAULT 0 COMMENT '状态：0-待审批，1-已激活，2-已禁用',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 8.2 users 表

```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  tenant_id INT COMMENT '租户 ID（NULL 表示公共工人）',
  username VARCHAR(50) NOT NULL COMMENT '用户名',
  password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
  phone VARCHAR(20) NOT NULL COMMENT '手机号',
  real_name VARCHAR(50) COMMENT '真实姓名',
  id_card VARCHAR(20) COMMENT '身份证号',
  skills VARCHAR(255) COMMENT '技能标签',
  role ENUM('tenant_admin', 'tenant_user', 'worker') NOT NULL COMMENT '角色',
  status TINYINT DEFAULT 0 COMMENT '状态：0-待激活，1-已激活，2-已禁用',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);
```

## 九、后续优化建议

### 9.1 通知功能
- [ ] 短信通知：审批结果通过短信通知租户
- [ ] 邮件通知：发送审批结果邮件
- [ ] 微信通知：通过微信公众号推送审批结果

### 9.2 审批优化
- [ ] 批量审批：支持批量审批多个租户
- [ ] 审批备注：总后台审批时可填写备注
- [ ] 自动审批：对于可信渠道的注册可设置自动审批

### 9.3 租户编码
- [ ] 编码自定义：允许租户注册时自选编码（需审核）
- [ ] 编码变更：支持租户申请变更编码
- [ ] 编码回收：已禁用租户的编码可回收重用

### 9.4 数据统计
- [ ] 租户数量统计图表
- [ ] 审批通过率统计
- [ ] 租户活跃度分析

### 9.5 工人管理
- [ ] 工人实名认证：接入第三方实名认证 API
- [ ] 工人技能认证：上传技能证书，总后台审核
- [ ] 工人信用体系：建立工人信用评分系统
